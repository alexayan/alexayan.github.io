## 服务器端预渲染与同构

本文基于 [dva](https://github.com/dvajs/dva)(React+Redux+react-router) 简单阐述前后端代码同构与服务器端预渲染的一种解决方案。

适用于 React+Redux 类似架构的项目。

### 特点

对于已有的项目，几乎不用改动任何代码，就能支持服务器端渲染。

### 服务器端渲染及同构

服务器端渲染，通常的解决方案是服务器端请求数据，并进行页面渲染，将渲染后的页面返回给客户端。因此必须对数据请求的方式进行特别设计，方便服务器端进行复用。

而我们期望的是在服务器端直接运行客户端应用，在页面初始化完成后，将页面返回给客户端。为了实现这个方案，需要解决的是何时开始进行页面的渲染，渲染的过早，数据不完整，渲染的过迟，影响页面的实时性，增加响应时间。

使用 dva 框架开发的 webapp，所有按照规范编写的异步数据请求都通过编写插件的来进行拦截。通过使用的计数器，当请求开始计数器 +1，请求结束技术器 -1，当计数器为 0 时，开始渲染整个页面并返回。（使用了 Redux 同理）

### 服务器预渲染

对于非个性化页面，没必要在每个请求到达服务器时进行页面的渲染，这样不仅消耗服务器资源，增加响应时间，也增加了复杂度。将页面渲染服务作为一个模块单独运行，渲染的结果使用内存等一些存储架构进行共享，当请求到达时，直接返回存储的渲染结果。

使用 createRoutes(routes), 对结果进行遍历，对可以获取需要预渲染的页面的 url 信息，避免人工添加。

## Practice

[https://github.com/alexayan/express-dva-ssr](https://github.com/alexayan/express-dva-ssr)

## 总结

以上是根据最近基于开发中的项目进行服务器端渲染迁移过程中的一点设计思路。当然并不存在银弹，架构随项目而变。

@alexayan
